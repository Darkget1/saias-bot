from iris import ChatContext, Bot
from iris.bot.models import ErrorContext
from bots.gemini import get_gemini
from bots.pyeval import python_eval, real_eval
from bots.stock import create_stock_image
from bots.imagen import get_imagen
from bots.lyrics import get_lyrics, find_lyrics
from bots.replyphoto import reply_photo
from bots.text2image import draw_text
from bots.coin import get_coin_info

from iris.decorators import *
from helper.BanControl import ban_user, unban_user
from iris.kakaolink import IrisLink

from bots.detect_nickname_change import detect_nickname_change
import sys, threading, random
from bots.party import handle_party_command
from bots.game_369 import handle_369_command, handle_369_turn  # âœ… ì¶”ê°€
iris_url = sys.argv[1]
bot = Bot(iris_url)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ë„Œì„¼ìŠ¤ í€´ì¦ˆ ë°ì´í„° & ìƒíƒœ
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

NONSENSE_QUIZZES = [
    {"q": "ë°±ê°€ì§€ ê³¼ì¼ì´ ì£½ê¸° ì§ì „ì„ ë‹¤ë¥¸ ë§ë¡œ?", "a": "ë°±ê³¼ì‚¬ì „"},
    {"q": "ì§€ê¸ˆ ëª‡ ì‹œ ëª‡ ë¶„?", "a": "ì§œì¥ë©´ì‹œí‚¤ì‹ ë¶„"},
    {"q": "Aì –ì†Œì™€ Bì –ì†Œê°€ ì‹¸ì›€ì„ í–ˆëŠ”ë° Bì –ì†Œê°€ ì´ê²¼ë‹¤ ì´ìœ ëŠ”?", "a": "ì—ì´ì¡Œì†Œ"},
    {"q": "í­ê·„ì´ ë‹¤ë‹ˆëŠ” ì¤‘í•™êµëŠ”?", "a": "ëƒ‰ë°©ì¤‘"},
    {"q": "ê¹¨ëœ¨ë¦¬ê³  ì¹­ì°¬ ë°›ëŠ” ê²ƒì€?", "a": "ì‹ ê¸°ë¡"},
    {"q": "ê±°ê¾¸ë¡œ ë§¤ë‹¬ë¦° ì§‘ì— ìˆ˜ì‹­ê°œì˜ ë¬¸ì´ ìˆëŠ” ê²ƒì€?", "a": "ë²Œì§‘"},
    {"q": "ì²­ë°”ì§€ë¥¼ ë‹ë³´ì´ê²Œ í•˜ëŠ” ê±¸ìŒê±¸ì´ëŠ”?", "a": "ì§„ì£¼ëª©ê±¸ì´"},
    {"q": "[ì°½ê³ ì— ì–‘ì´ˆê°€ ê½‰ ì°¨ìˆëŠ” ê²ƒ]ì„ ì„¸ ê¸€ìë¡œ?", "a": "ì´ˆë§Œì›"},
    {"q": "ëª» ì‚¬ì˜¨ë‹¤ê³  í•´ë†“ê³  ì‚¬ì˜¨ ê²ƒì€?", "a": "ëª»"},
    {"q": "ë¬´ê°€ ìê¸°ì†Œê°œë¥¼ í•  ë•Œ í•˜ëŠ” ë§ì€?", "a": "ë‚˜ë¬´"},
    {"q": "ìš´ì „í•˜ëŠ” ì‚¬ëŒë“¤ì´ ê°€ì¥ ì‹«ì–´í•˜ëŠ” ì¶¤ì€?", "a": "ìš°ì„ ë©ˆì¶¤"},
    {"q": "ì‹¸ì›€ì„ ì˜í•˜ëŠ” ì˜¤ë¦¬ëŠ”?", "a": "ì„ì§€ë¬¸ë•"},
    {"q": "ëŠ˜ ì²­ë°”ì§€ë¥¼ ì›í•˜ëŠ” ê½ƒì€?", "a": "ì§„ë‹¬ë˜"},
    {"q": "ë¹„ ì¹œêµ¬ê°€ ë¹„í•œí…Œ ì‚¬ìš°ë””ì•„ëƒê³  ë¬¼ì–´ë³´ëŠ” ë§ì€?", "a": "ì‚¬ìš°ë””ì•Œì•„ë¹„ì•¼"},
    {"q": "ì–‘ ì¤‘ì—ì„œ ê°€ì¥ ëœ¨ê±°ìš´ ì–‘ì€?", "a": "íƒœì–‘"},
    {"q": "ê³ ê¸° ë¨¹ì„ ë•Œ ë”°ë¼ì˜¤ëŠ” ê°œëŠ”?", "a": "ì´ì‘¤ì‹œê°œ"},
    {"q": "ì¢€ë¹„ëŠ” ì™œ ë©ì²­í• ê¹Œ?", "a": "ë¨¸ë¦¬ê°€ì¢€ë¹„ì–´ì„œ"},
    {"q": "ì´ ì„¸ìƒì—ì„œ ê°€ì¥ ë”ìš´ ë°”ë‹¤ëŠ”?", "a": "ì—´ë°”ë‹¤"},
    {"q": "[í˜ì„¼ ë§ê³¼ ê³ ì–‘ì´]ë¥¼ ë„¤ ê¸€ìë¡œ?", "a": "ìŠˆí¼ë§ˆì¼“"},
    {"q": "ê°€ìˆ˜ ìƒ¤ì´ë‹ˆê°€ ë‹¤ë‹ˆëŠ” ê³ ë“±í•™êµëŠ”?", "a": "ì•„ë¯¸ê³ "},
    {"q": "ê°„ì§œì¥ì´ ê·¸ëƒ¥ ì§œì¥ë³´ë‹¤ ë¹„ì‹¼ ì´ìœ ëŠ”?", "a": "ê°„ ë•Œë¬¸ì´ì•¼"},
    {"q": "ëˆì¸ë°, ê²°í˜¼ì„ í•´ì•¼ ìƒê¸°ëŠ” ëˆì€?", "a": "ì‚¬ëˆ"},
    {"q": "ì‚¬ëŒë“¤ì´ ê°€ì¥ ì¢‹ì•„í•˜ëŠ” ì˜í™”ëŠ”?", "a": "ë¶€ê·€ì˜í™”"},
    {"q": "ì•„ê¸°ë¼ì§€ ì‚¼ í˜•ì œì—ì„œ í•œ ë§ˆë¦¬ê°€ ë” ëŠ˜ì–´ë‚˜ë©´?", "a": "ëª¨ë‘ ì£½ìŒ"},
    {"q": "ìŠ¬í”ˆ ì‚¬ëŒë“¤ë¼ë¦¬ ëª¨ì—¬ì„œ ë…¸ëŠ” ê²ƒ?", "a": "ìœ ìœ ìƒì¢…"},
    {"q": "ì•„ë§ˆì¡´ì—” ëˆ„ê°€ ì‚´ê¹Œ?", "a": "ì¡´"},
    {"q": "í•œêµ­ì€ ì›, ì¼ë³¸ì€ ì—”, í˜¸ì£¼ëŠ”?", "a": "í˜¸ì£¼ë¨¸ë‹ˆ"},
    {"q": "ì‚¬ëŒ ì„¸ ëª…ì´ íƒ„ ì°¨ë¥¼ ì„¸ ê¸€ìë¡œ?", "a": "ì¸ì‚¼ì°¨"},
    {"q": "ë¹„ê°€ ì–¼ì–´ì£½ìœ¼ë©´?", "a": "ë¹„ë™ì‚¬"},
    {"q": "ë‹­ì´ ìŠ¤í‚¤ë‹ˆ ë°”ì§€ë¥¼ ì…ê³  í•˜ëŠ” ë§?", "a": "ê¼¬ë¼ì˜¤"},
    {"q": "ëª¨ì ë§¤ì¥ ì§„ì—´ëŒ€ ì‚¬ì´ì— ì‹ ë°œì„ ë‘ë©´?", "a": "ìº¡ì‚¬ì´ì‹ "},
    {"q": "ì‚¬ê³¼ê°€ ì›ƒìœ¼ë©´?", "a": "í’‹ì‚¬ê³¼"},
    {"q": "ë‹¤ì •í•¨ì˜ ë°˜ëŒ€ëŠ”?", "a": "ì„ íƒì¥ì• "},
    {"q": "ë¶ ì¤‘ì—ì„œ ê°€ì¥ í° ë¶ì€?", "a": "ë™ì„œë‚¨ë¶"},
    {"q": "ê¹¨ì¸ë°, ë¨¹ì§€ ëª»í•˜ëŠ” ê¹¨ëŠ”?", "a": "ì£¼ê·¼ê¹¨"},
    {"q": "ë…ìˆ˜ë¦¬ê°€ ë¶ˆì— íƒ€ë©´ ì–´ë–¤ ì†Œë¦¬ê°€ ë‚ ê¹Œ?", "a": "ì´ê¸€ì´ê¸€"},
    {"q": "ê³µê¸° 1kgì™€ ê¸ˆ 1kg ì¤‘, ì–´ëŠ ê²ƒì´ ë” ë¬´ê±°ìš¸ê¹Œ?", "a": "ë˜‘ê°™ë‹¤"},
    {"q": "í‰ìƒ ë¶€ë™ì‚° íˆ¬ê¸°ë§Œ í•œ ì‚¬ëŒì´ ë‚¨ê¸´ ìœ ì–¸ì€?", "a": "ì €ìŠ¹ì‚¬ì"},
    {"q": "ë§ì¹  ìˆ˜ë¡ ëˆì„ ë²„ëŠ” ì‚¬ëŒì€?", "a": "ì–´ë¶€"},
    {"q": "êµ°ì¸ì´ ëˆì„ ë‹¤ ì“°ë©´?", "a": "ë¬´ì „ë³‘"},
    {"q": "ì˜¤ë¦¬ì¸ë°, ë¬¼ì†ì—ì„œë§Œ ì‚¬ëŠ” ì˜¤ë¦¬ëŠ”?", "a": "ê°€ì˜¤ë¦¬"},
    {"q": "ì˜¤ë°±ì—ì„œ ë°±ì„ ë¹¼ë©´?", "a": "ì˜¤"},
    {"q": "ëŒ€í•™ìƒë“¤ì˜ ì „íˆ¬ë ¥ì´ ë†’ì„ ë•ŒëŠ”?", "a": "ê°œê°•í• ë•Œ"},
    {"q": "ì¼ì›ë™ë³´ë‹¤ ì‹¼ ë™ë„¤ ì´ë¦„ì€?", "a": "ì‚¼ì „ë™"},
    {"q": "ê³µê¸°ë§Œ ë¨¹ì–´ë„ ì‚´ì´ ì°ŒëŠ” ê²ƒì€?", "a": "í’ì„ "},
    {"q": "[ë³‘ì— ê±¸ë¦° ê°€ìˆ˜ í˜¸ë€]ì„ ë„¤ê¸€ìë¡œ?", "a": "ë³‘ìí˜¸ë€"},
    {"q": "íŒ”ì´ ë„¤ê°œì¸ ì‚¬ëŒë“¤ì´ ì‚¬ëŠ” ë‚˜ë¼ëŠ”?", "a": "ë„¤íŒ”"},
    {"q": "ê½ƒê°€ê²Œ ì£¼ì¸ì¥ì´ ì œì¼ ì‹«ì–´í•˜ëŠ” ë‚˜ë¼ëŠ”?", "a": "ì‹œë“œë‹ˆ"},
    {"q": "ì²œí•˜ì¥ì‚¬ê°€ íƒ€ê³  ë‹¤ë‹ˆëŠ” ì°¨ëŠ”?", "a": "ìœ¼ëì°¨ì°¨"},
    {"q": "êµíšŒì— ê°€ë©´ ì£¼ëŠ” ëˆì€?", "a": "êµ¬ì›"},
    {"q": "ê°€ìŠ´ì— í‘ì‹¬ì„ í’ˆê³  ìˆëŠ” ê²ƒì€?", "a": "ì—°í•„"},
    {"q": "ì´ìƒí•œ ì‚¬ëŒë“¤ì´ ëª¨ì´ëŠ” ê³³ì€?", "a": "ì¹˜ê³¼"},
    {"q": "ì™•ê³¼ ì²˜ìŒ ë§Œë‚  ë•Œ í•˜ëŠ” ì¸ì‚¬?", "a": "í•˜ì´í‚¹"},
    {"q": "ì§ì ‘ ë§Œë“  ì´ì€?", "a": "ì†ìˆ˜ê±´"},
    {"q": "ëŒí•˜ë¥´ë°©ì´ ì„œì»¤ìŠ¤ë‹¨ì„ ë³´ê³ í•˜ëŠ” ë§ì€?", "a": "ì œì£¼ë„ì¢‹ë‹¤"},
    {"q": "ì–¼ìŒì´ ì£½ìœ¼ë©´?", "a": "ë‹¤ì´ë¹™"},
    {"q": "[ì œë°œ ìš¸ì§€ë§ˆ~]ë¥¼ í•œ ê¸€ìë¡œ?", "a": "ëš"},
    {"q": "ë¬´ì—‡ì´ë“  íŒ” ìˆ˜ ìˆëŠ” ë‚˜ë¼ëŠ”?", "a": "íŒ”ë¼ìš°"},
    {"q": "ê²°ì • ì¥ì• ê°€ ë§ì€ ëŒ€í•™ì€?", "a": "ê³ ë ¤ëŒ€í•™êµ"},
    {"q": "ê³°ëŒì´ í‘¸ê°€ ì°¨ì— ì¹˜ì´ë©´?", "a": "ì¹´í‘¸ì¹˜ë…¸"},
    {"q": "ì‚¬ìë¥¼ ë„£ê³  ë“ì¸ êµ­ì€?", "a": "ë™ë¬¼ì˜ì™•êµ­"},
    {"q": "ë„ë‘‘ì´ í›”ì¹œ ëˆì„ ë„¤ ê¸€ìë¡œ?", "a": "ìŠ¬ê·¸ë¨¸ë‹ˆ"},
    {"q": "ë–¡ ì¤‘ì— ê°€ì¥ ë¹¨ë¦¬ ë¨¹ëŠ” ë–¡ì€?", "a": "í—ë ˆë²Œë–¡"},
    {"q": "ê³ ì¶”ì¥ ë³´ë‹¤ ë†’ì€ ê²ƒì€?", "a": "ì´ˆê³ ì¶”ì¥"},
    {"q": "[ì†Œ ë„¤ ë§ˆë¦¬]ë¥¼ ë‘ ê¸€ìë¡œ?", "a": "ì†Œí¬"},
    {"q": "ìš°ë¦¬ë‚˜ë¼ ì‚¬ëŒë“¤ì´ ë‹¤ ê°™ì´ ì“°ëŠ” ê°€ìœ„ëŠ”?", "a": "í•œê°€ìœ„"},
    {"q": "ë”©ë™ëŒ•ì˜ ë°˜ëŒ€ë§ì€?", "a": "ë•¡"},
    {"q": "ë§Œ ë§ˆë¦¬ì˜ ì†Œë“¤ì´ ì ˆì„í•˜ëŠ” ê²ƒì„ ì„¸ê¸€ìë¡œ?", "a": "ë§Œìš°ì ˆ"},
    {"q": "ì„¸ìƒì—ì„œ ê°€ì¥ ì˜ ê¹¨ì§€ëŠ” ì°½ë¬¸ì€?", "a": "ì™€ì¥ì°½"},
    {"q": "ì•„ì¬ê°€ ì¢‹ì•„í•˜ëŠ” ì•…ê¸°ëŠ”?", "a": "ì•„ìŸ"},
    {"q": "[ê³¨ë±…ì´ê°€ ë¬´ë¥¼ ë•Œë ¸ë‹¤]ë¥¼ ë‹¤ì„¯ê¸€ìë¡œ?", "a": "ê³¨ë±…ì´ë¬´ì¹¨"},
    {"q": "ê¸¸ë©´ ê¸¸ ìˆ˜ë¡ ì¢‹ì€ ê°•ì€?", "a": "ë§Œìˆ˜ë¬´ê°•"},
    {"q": "êµ´ì¸ë° ë¨¹ì„ ìˆ˜ ì—†ëŠ” êµ´ì€?", "a": "ë™êµ´"},
    {"q": "ì„¸ìƒì—ì„œ ê°€ì¥ ë”ëŸ¬ìš´ ê°•ì€?", "a": "ìš”ê°•"},
    {"q": "3ì›”ì— ëŒ€í•™ìƒì´ ê°•í•œ ì´ìœ ëŠ”?", "a": "ê°œê°•í•´ì„œ"},
    {"q": "ì—„ë§ˆê°€ ê¸¸ì„ ìƒìœ¼ë©´?", "a": "ë§˜ë§ˆë¯¸ì•„"},
    {"q": "êµ¬ë¦¬ëŠ” êµ¬ë¦¬ì¸ë° ëª» ì“°ëŠ” êµ¬ë¦¬ëŠ”?", "a": "ë©í……êµ¬ë¦¬"},
    {"q": "ê°€ìˆ˜ ì„¤ìš´ë„ê°€ ì˜· ë²—ëŠ” ìˆœì„œëŠ”?", "a": "ìƒí•˜ì˜"},
    {"q": "ëª¨ë“  ì‚¬ëŒë“¤ì´ ê±°ì§“ë§ë§Œ í•˜ëŠ” ì ˆì€?", "a": "ë§Œìš°ì ˆ"},
    {"q": "ì‚¬ëŒì´ ê°€ì¥ ë§ì´ ë§í•˜ëŠ” ì†Œë¦¬ëŠ”?", "a": "ìˆ¨ì†Œë¦¬"},
    {"q": "ë‚¨ë“¤ê³¼ ë°˜ëŒ€ë¡œ ìƒí™œí•˜ëŠ” ì¥ëŠ”?", "a": "ë°•ì¥"},
    {"q": "ê³°ì€ ì‚¬ê³¼ë¥¼ ì–´ë–»ê²Œ ë¨¹ì„ê¹Œ?", "a": "ë² ì–´ë¨¹ìŒ"},
    {"q": "ì†ì„ ì˜¬ë¦¬ë©´ ë©ˆì¶”ëŠ” ê²ƒì€?", "a": "íƒì‹œ"},
    {"q": "ìš°ë¦¬ë‚˜ë¼ì—ì„œ ê¹€ì´ ê°€ì¥ ë§ì´ë‚˜ëŠ” ê³³ì€?", "a": "ëª©ìš•íƒ•"},
    {"q": "ì˜¤ë˜ ì‚´ ê²ƒ ê°™ì€ ì—°ì˜ˆì¸ì€?", "a": "ì´ìŠ¹ê¹ë‹ˆë‹¤"},
    {"q": "[ë¼ì§€ê°€ ë°©ê·€ë¥¼ ë€Œë©´]ì„ ì„¸ê¸€ìë¡œ?", "a": "ëˆê°€ìŠ¤"},
    {"q": "ìˆ ì„ ì¢‹ì•„í•˜ëŠ” ì‚¬ëŒë“¤ì´ ëª¨ì¸ ë‚˜ë¼ëŠ”?", "a": "í˜¸ì£¼"},
    {"q": "ì–´ë¶€ê°€ ê°€ì¥ ì‹«ì–´í•˜ëŠ” ë…¸ë˜ëŠ”?", "a": "ë°”ë‹¤ê°€ìœ¡ì§€ë¼ë©´"},
    {"q": "[ê°€ìˆ˜ ë¹„ê°€ LAì— ê°ˆ ê²ƒì´ë‹¤]ë¥¼ ë„¤ ê¸€ìë¡œ?", "a": "LAê°ˆë¹„"},
    {"q": "ì†¡í•´ê°€ ìƒ¤ì›Œë¥¼ í•˜ë©´?", "a": "ë½€ì†¡ë½€ì†¡í•´"},
    {"q": "ëˆˆìœ¼ë¡œ ëª» ë³´ê³ , ì…ìœ¼ë¡œë§Œ ë³´ëŠ” ê²ƒì€?", "a": "ë§›"},
    {"q": "ëª½ê³¨ ì‚¬ëŒì´ ë•€ì„ í˜ë¦¬ë©´?", "a": "ëª½ê³¨ëª½ê³¨"},
    {"q": "ë“¤ì–´ê°€ëŠ” ì…êµ¬ëŠ” í•˜ë‚˜ì§€ë§Œ, ë‚˜ì˜¤ëŠ” ì…êµ¬ëŠ” 2ê°œì¸ ê²ƒì€?", "a": "ë°”ì§€"},
    {"q": "ì‚¬ëŒì´ ë¨¹ì„ ìˆ˜ ìˆëŠ” ì œë¹„ëŠ”?", "a": "ìˆ˜ì œë¹„"},
    {"q": "[ìì‹ì´ ì•„í™‰ëª…ì´ë‹¤]ë¥¼ ì„¸ ê¸€ìë¡œ?", "a": "ì•„ì´êµ¬"},
    {"q": "ìš°ë¦¬ë‚˜ë¼ê¹Œì§€ ì„ìœ ê°€ ë„ì°©í•˜ëŠ”ë° ì†Œìš”ë˜ëŠ” ì‹œê°„ì€?", "a": "ì˜¤ì¼"},
    {"q": "ì‚¬ëŒì˜ ëª¸ë¬´ê²Œê°€ ê°€ì¥ ë§ì´ ë‚˜ê°ˆ ë•ŒëŠ”?", "a": "ì² ë“¤ë•Œ"},
    {"q": "ê³¤ì¶©ì˜ ëª¸ì„ ì‚¼ë“±ë¶„ í•˜ë©´?", "a": "ì£½ëŠ”ë‹¤"},
    {"q": "ê³¼ìê°€ ìê¸°ì†Œê°œë¥¼ í•˜ë©´?", "a": "ì „ê³¼ì"},
    {"q": "í†± ì¤‘ì—ì„œ ê°€ì¥ ìœ ëª…í•œ í†±ì€?", "a": "í†±ìŠ¤íƒ€"},

]

# ë°©(ë˜ëŠ” ì±„íŒ…)ë³„ ì§„í–‰ ì¤‘ì¸ í€´ì¦ˆ ìƒíƒœ
# key: room_id, value: {"q": str, "a": str}
NONSENSE_STATE = {}


def get_room_id(chat: ChatContext) -> str:
    """
    ë°©/ì±„íŒ…ì„ êµ¬ë¶„í•  ìˆ˜ ìˆëŠ” ê³ ìœ ê°’.
    iris ë²„ì „ì— ë§ê²Œ í•„ìš”í•˜ë©´ ìˆ˜ì •í•´ì„œ ì‚¬ìš©.
    """
    if hasattr(chat, "room") and hasattr(chat.room, "id"):
        return str(chat.room.id)
    # ë°© ì •ë³´ê°€ ì—†ë‹¤ë©´, ë³´ë‚¸ ì‚¬ëŒ ê¸°ì¤€ìœ¼ë¡œë¼ë„ êµ¬ë¶„
    return str(chat.sender.id)


def start_nonsense_quiz(chat: ChatContext):
    room_id = get_room_id(chat)
    quiz = random.choice(NONSENSE_QUIZZES)
    NONSENSE_STATE[room_id] = quiz

    chat.reply(
        "ğŸ§  ë„Œì„¼ìŠ¤ í€´ì¦ˆ ë‚˜ê°‘ë‹ˆë‹¤!\n\n"
        f"Q. {quiz['q']}\n\n"
        "ì •ë‹µì€ `/ë‹µ ë‹µ` ì´ëŸ° ì‹ìœ¼ë¡œ ë³´ë‚´ì¤˜!\n"
        "ì˜ˆ) `/ë‹µ ì—´ë°›ì•„`"
    )


def check_nonsense_answer(chat: ChatContext):
    room_id = get_room_id(chat)
    quiz = NONSENSE_STATE.get(room_id)

    if not quiz:
        chat.reply("ì§€ê¸ˆ ì§„í–‰ ì¤‘ì¸ ë„Œì„¼ìŠ¤ í€´ì¦ˆê°€ ì—†ì–´ìš” ğŸ˜…\n`/ë„Œì„¼ìŠ¤`ë¡œ ìƒˆ ë¬¸ì œë¥¼ ì‹œì‘í•´ì¤˜!")
        return

    # âœ… iris êµ¬ì¡° ê·¸ëŒ€ë¡œ ì‚¬ìš©
    # - chat.message.command  = "!ì •ë‹µ"
    # - chat.message.param    = "ì—´ë°›ì•„"
    user_answer = getattr(chat.message, "param", "").strip()

    if not user_answer:
        chat.reply("ì •ë‹µ ë’¤ì— ë‚´ìš©ì„ ê°™ì´ ì¨ì¤˜! ì˜ˆ: `!ì •ë‹µ ì—´ë°›ì•„`")
        return

    correct = quiz["a"].strip().lower()
    user_norm = user_answer.lower()

    if user_norm == correct:
        chat.reply(
            f"ğŸ‰ ì •ë‹µ! ì •ë‹µì€ `{quiz['a']}` ë§ì•„ìš”!\n"
            "ë˜ í’€ê³  ì‹¶ìœ¼ë©´ `/ë„Œì„¼ìŠ¤`ë¼ê³  ë³´ë‚´ì¤˜!"
        )
        NONSENSE_STATE.pop(room_id, None)
    else:
        chat.reply(
            f"âŒ ì•„ì‰½ë‹¤... `{user_answer}` ëŠ” ì •ë‹µì´ ì•„ë‹ˆì•¼.\n"
            "ë‹¤ì‹œ í•œ ë²ˆ ìƒê°í•´ë³¼ë˜?\n"
            "í¬ê¸°í•˜ê³  ì‹¶ìœ¼ë©´ `/í¬ê¸°` ë¼ê³  ë³´ë‚´ì¤˜!"
        )

def giveup_nonsense_quiz(chat: ChatContext):
    room_id = get_room_id(chat)
    quiz = NONSENSE_STATE.get(room_id)

    if not quiz:
        chat.reply("í¬ê¸°í•  í€´ì¦ˆê°€ ì—†ì–´ìš” ğŸ˜…\n`/ë„Œì„¼ìŠ¤`ë¡œ ìƒˆ ë¬¸ì œë¥¼ ì‹œì‘í•´ì¤˜!")
        return

    chat.reply(
        f"ğŸ“ ì •ë‹µ ê³µê°œ!\n\n"
        f"Q. {quiz['q']}\nA. {quiz['a']}\n\n"
        "ë˜ í’€ê³  ì‹¶ìœ¼ë©´ `/ë„Œì„¼ìŠ¤`!"
    )
    NONSENSE_STATE.pop(room_id, None)


@bot.on_event("message")
@is_not_banned
def on_message(chat: ChatContext):
    try:
        cmd = chat.message.command

        # âœ… 1) 369 ëª…ë ¹ì–´ ë¨¼ì € ì²˜ë¦¬
        if handle_369_command(chat):
            # ëª…ë ¹ì–´ ì²˜ë¦¬ í›„ì—ë„ ì¼ë°˜ í„´ ì²´í¬ (ë°”ë¡œ ë‹¤ìŒ ì‚¬ëŒì´ ì´ì–´ì„œ ì¹  ìˆ˜ ìˆê²Œ)
            handle_369_turn(chat)
            return

        # âœ… 2) ë‚˜ë¨¸ì§€ ê¸°ì¡´ ëª…ë ¹ì–´ ì²˜ë¦¬
        match cmd:

            case "!hhi":
                chat.reply(f"Hello {chat.sender.name}")

            case "!tt" | "!ttt" | "!í”„ì‚¬" | "!í”„ì‚¬ë§":
                reply_photo(chat, kl)

            case "!iris":
                chat.reply_media("res/help.png")

            case "!gi" | "!i2i" | "!ë¶„ì„":
                get_gemini(chat)

            case "!ipy":
                python_eval(chat)

            case "!iev":
                real_eval(chat, kl)

            case "!ban":
                ban_user(chat)

            case "!unban":
                unban_user(chat)

            case "!ì£¼ì‹":
                create_stock_image(chat)

            case "!ig":
                get_imagen(chat)

            case "!ê°€ì‚¬ì°¾ê¸°":
                find_lyrics(chat)

            case "!ë…¸ë˜ê°€ì‚¬":
                get_lyrics(chat)

            case "!í…ìŠ¤íŠ¸" | "!ì‚¬ì§„" | "!ê»„ë¬´ìƒˆ" | "!ë©ˆì¶°" | "!ì§€ì›Œ" | "!ì§„í–‰" | "!ë§ëŒ€ê¾¸" | "!í…ìŠ¤íŠ¸ì¶”ê°€" | "!ì—…ë¡œë“œ":
                draw_text(chat)

            case "!ì½”ì¸" | "!ë‚´ì½”ì¸" | "!ë°”ë‚¸" | "!ê¹€í”„" | "!ë‹¬ëŸ¬" | "!ì½”ì¸ë“±ë¡" | "!ì½”ì¸ì‚­ì œ":
                get_coin_info(chat)

            case "/ë„Œì„¼ìŠ¤":
                start_nonsense_quiz(chat)

            case "/ë‹µ":
                check_nonsense_answer(chat)

            case "/í¬ê¸°":
                giveup_nonsense_quiz(chat)

            case "/íŒŒí‹°" | "/ì°¸ê°€" | "/íŒŒí‹°í˜„í™©" | "/íŒŒí‹°ì·¨ì†Œ" | "/íŒŒí‹°ì‚­ì œ" | "/ë ˆì´ë“œíŒŒí‹°":
                handle_party_command(chat)

            case _:
                # 369 ì´ì™¸ì˜ ì¼ë°˜ í…ìŠ¤íŠ¸ëŠ” ì—¬ê¸°ë¡œ ë–¨ì–´ì§
                pass

        # âœ… 3) ì¼ë°˜ ë©”ì‹œì§€ì— ëŒ€í•´ì„œ 369 í„´ ì²˜ë¦¬
        handle_369_turn(chat)

    except Exception as e:
        print(e)

# ì…ì¥ê°ì§€
@bot.on_event("new_member")
def on_newmem(chat: ChatContext):
    # chat.reply(f"Hello {chat.sender.name}")
    pass


# í‡´ì¥ê°ì§€
@bot.on_event("del_member")
def on_delmem(chat: ChatContext):
    # chat.reply(f"Bye {chat.sender.name}")
    pass


@bot.on_event("error")
def on_error(err: ErrorContext):
    print(err.event, "ì´ë²¤íŠ¸ì—ì„œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤", err.exception)
    # sys.stdout.flush()


if __name__ == "__main__":
    # ë‹‰ë„¤ì„ê°ì§€ë¥¼ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ê²½ìš° ì£¼ì„ì²˜ë¦¬
    nickname_detect_thread = threading.Thread(
        target=detect_nickname_change,
        args=(bot.iris_url,),
    )
    nickname_detect_thread.start()

    # ì¹´ì¹´ì˜¤ë§í¬ë¥¼ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ê²½ìš° ì£¼ì„ì²˜ë¦¬
    kl = IrisLink(bot.iris_url)

    bot.run()
